(function(f){function e(l,k,j,i){var g=e.sinks,h;for(h in g){if(g.hasOwnProperty(h)&&g[h].enabled){try{return new g[h](l,k,j,i)}catch(m){}}}throw"No audio sink available."}function d(g){this.boundTo=g;this.buffers=[];g.activeRecordings.push(this)}d.prototype={add:function(g){this.buffers.push(g)},clear:function(){this.buffers=[]},stop:function(){var g=this.boundTo.activeRecordings,h;for(h=0;h<g.length;h++){if(g[h]===this){g.splice(h--,1)}}},join:function(){var m=0,o=0,j=this.buffers,g,p,k,h=j.length;for(k=0;k<h;k++){m+=j[k].length}g=new Float32Array(m);for(k=0;k<h;k++){for(p=0;p<j[k].length;p++){g[o+p]=j[k][p]}o+=j[k].length}return g}};function c(){}e.SinkClass=c;c.prototype={sampleRate:44100,channelCount:2,preBufferSize:4096,writePosition:0,writeMode:"async",channelMode:"interleaved",previousHit:0,ringBuffer:null,ringOffset:0,start:function(j,i,h,g){this.channelCount=isNaN(i)?this.channelCount:i;this.preBufferSize=isNaN(h)?this.preBufferSize:h;this.sampleRate=isNaN(g)?this.sampleRate:g;this.readFn=j;this.activeRecordings=[];this.previousHit=+new Date;this.asyncBuffers=[];this.syncBuffers=[]},process:function(h,i){this.ringBuffer&&(this.channelMode==="interleaved"?this.ringSpin:this.ringSpinInterleaved).apply(this,arguments);this.writeBuffersSync.apply(this,arguments);if(this.readFn){if(this.channelMode==="interleaved"){this.readFn.apply(this,arguments)}else{var g=e.deinterleave(h,this.channelCount);this.readFn.apply(this,[g].concat([].slice.call(arguments,1)));e.interleave(g,this.channelCount,h)}}this.writeBuffersAsync.apply(this,arguments);this.recordData.apply(this,arguments);this.previousHit=+new Date;this.writePosition+=h.length/i},record:function(){return new d(this)},recordData:function(h){var k=this.activeRecordings,j,g=k.length;for(j=0;j<g;j++){k[j].add(h)}},writeBuffersAsync:function(j){var h=this.asyncBuffers,g=j.length,k,o,m,q,p;if(h){for(m=0;m<h.length;m++){k=h[m];o=k.b.length;p=k.d;k.d-=Math.min(p,g);for(q=0;q+p<g&&q<o;q++){j[q+p]+=k.b[q]}k.b=k.b.subarray(q+p);m>=o&&h.splice(m--,1)}}},writeBuffersSync:function(j){var h=this.syncBuffers,g=j.length,k=0,m=0;for(;k<g&&h.length;k++){j[k]+=h[0][m];if(h[0].length<=m){h.splice(0,1);m=0;continue}m++}if(h.length){h[0]=h[0].subarray(m)}},writeBufferAsync:function(h,i){h=this.mode==="deinterleaved"?e.interleave(h,this.channelCount):h;var g=this.asyncBuffers;g.push({b:h,d:isNaN(i)?~~((+new Date-this.previousHit)/1000*this.sampleRate):i});return g.length},writeBufferSync:function(h){h=this.mode==="deinterleaved"?e.interleave(h,this.channelCount):h;var g=this.syncBuffers;g.push(h);return g.length},writeBuffer:function(){this[this.writeMode==="async"?"writeBufferAsync":"writeBufferSync"].apply(this,arguments)},getSyncWriteOffset:function(){var g=this.syncBuffers,j=0,h;for(h=0;h<g.length;h++){j+=g[h].length}return j},getPlaybackTime:function(){return this.writePosition-this.preBufferSize},ringSpin:function(j){var k=this.ringBuffer,h=j.length,g=k.length,o=this.ringOffset,n;for(n=0;n<h;n++){j[n]+=k[o];o=(o+1)%g}this.ringOffset=o},ringSpinDeinterleaved:function(q){var p=this.ringBuffer,o=q.length,g=p.length,k=p[0].length,s=g*k,j=this.ringOffset,r,h;for(r=0;r<o;r+=g){for(h=0;h<g;h++){q[r+h]+=p[h][j]}j=(j+1)%k}this.ringOffset=h}};function a(j,i,g,h){g=g||i.prototype;i.prototype=new e.SinkClass();i.prototype.type=j;i.enabled=!h;for(h in g){if(g.hasOwnProperty(h)){i.prototype[h]=g[h]}}a[j]=i}a("moz",function(){var p=this,i=0,o=null,n=new Audio(),m,l,j,k,g;p.start.apply(p,arguments);p.preBufferSize=isNaN(arguments[2])?p.sampleRate/2:p.preBufferSize;function h(){if(o){m=n.mozWriteAudio(o);i+=m;if(m<o.length){o=o.subarray(m);return o}o=null}l=n.mozCurrentSampleOffset();j=Number(l+p.preBufferSize*p.channelCount-i);if(j>0){k=new Float32Array(j);p.process(k,p.channelCount);m=n.mozWriteAudio(k);if(m<k.length){o=k.subarray(m)}i+=m}}n.mozSetup(p.channelCount,p.sampleRate);p.kill=e.doInterval(h,20);p._bufferFill=h;p._audio=n},{getPlaybackTime:function(){return this._audio.mozCurrentSampleOffset()/this.channelCount}});var b=[];a("webkit",function(n,l,j,i){var g=this,k=new (window.AudioContext||webkitAudioContext)(),m=k.createJavaScriptNode(j,0,l);g.start.apply(g,arguments);function h(v){var o=v.outputBuffer,r=o.numberOfChannels,t,q,s=o.length,w=o.size,u=new Array(r),p=new Float32Array(s*r);for(t=0;t<r;t++){u[t]=o.getChannelData(t)}g.process(p,g.channelCount);for(t=0;t<s;t++){for(q=0;q<r;q++){u[q][t]=p[t*g.channelCount+q]}}}m.onaudioprocess=h;m.connect(k.destination);g.sampleRate=k.sampleRate;g._context=k;g._node=m;g._callback=h;b.push(m)},{kill:function(){},getPlaybackTime:function(){return this._context.currentTime*this.sampleRate},});a.webkit.fix82795=b;a("dummy",function(){var g=this;g.start.apply(g,arguments);function h(){var i=new Float32Array(g.preBufferSize*g.channelCount);g.process(i,g.channelCount)}g.kill=e.doInterval(h,g.preBufferSize/g.sampleRate*1000);g._callback=h},null,true);e.sinks=e.devices=a;e.Recording=d;e.doInterval=function(m,i){var h=typeof window==="undefined"?undefined:window.MozBlobBuilder||window.WebKitBlobBuilder||window.MSBlobBuilder||window.OBlobBuilder||window.BlobBuilder,l,k,g;if((e.doInterval.backgroundWork||e.devices.moz.backgroundWork)&&h){try{g=new h();g.append('setInterval(function(){ postMessage("tic"); }, '+i+");");k=(window.MozURL||window.webkitURL||window.MSURL||window.OURL||window.URL).createObjectURL(g.getBlob());l=new Worker(k);l.onmessage=function(){m()};return function(){l.terminate();(window.MozURL||window.webkitURL||window.MSURL||window.OURL||window.URL).revokeObjectURL(k)}}catch(j){}}l=setInterval(m,i);return function(){clearInterval(l)}};e.doInterval.backgroundWork=true;(function(){function g(h,i){if(h&&i){g[h]=i}else{if(h&&g[h] instanceof Function){e.interpolate=g[h]}}return g[h]}e.interpolation=g;g("linear",function(h,l){var k=Math.floor(l),j=k+1,i=l-k;j=j<h.length?j:0;return h[k]*(1-i)+h[j]*i});g("nearest",function(h,i){return i>=h.length-0.5?h[0]:h[Math.round(i)]});g("linear")}());e.resample=function(q,g,t,u,j){var p=arguments.length,m=p===2?g:p===3?g/t:u/g*j/t,o=q.length,h=Math.ceil(o/m),s=new Float32Array(h),r,k;for(r=0,k=0;r<o;r+=m){s[k++]=e.interpolate(q,r)}return s};e.deinterleave=function(h,o){var g=h.length,m=g/o,j=[],k,p;for(k=0;k<o;k++){j[k]=new Float32Array(m);for(p=0;p<m;p++){j[k][p]=h[p*o+k]}}return j};e.interleave=function(j,o,h){o=o||j.length;var g=j[0].length,m=j.length,k,p;h=h||new Float32Array(g*o);for(k=0;k<m;k++){for(p=0;p<g;p++){h[k+p*o]=j[k][p]}}return h};e.mix=function(j){var h=[].slice.call(arguments,1),g,k,m;for(m=0;m<h.length;m++){g=Math.max(j.length,h[m].length);for(k=0;k<g;k++){j[k]+=h[m][k]}}return j};e.resetBuffer=function(h){var g=h.length,j;for(j=0;j<g;j++){h[j]=0}return h};e.clone=function(j,g){var h=j.length,k;g=g||new Float32Array(h);for(k=0;k<h;k++){g[k]=j[k]}return g};e.createDeinterleaved=function(k,j){var g=new Array(j),h;for(h=0;h<j;h++){g[h]=new Float32Array(k)}return g};f.Sink=e}(function(){return this}()));